{% extends "layout.html" %}

{% block body %}
<div class="max-w-6xl mx-auto px-4">
    <div class="flex flex-col md:flex-row gap-8 min-h-[600px]">

        <!-- 左侧导航栏 -->
        <aside class="w-full md:w-64 space-y-2">
            <div class="bg-white rounded-3xl p-4 shadow-sm border border-gray-100 sticky top-24">
                <div class="px-4 py-3 mb-4">
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-widest">编辑模式</p>
                </div>
                <nav class="space-y-1">
                    <button onclick="switchTab('basic')" id="btn-basic" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition font-bold text-sm">
                        <i data-lucide="user" class="w-5 h-5"></i> 基本信息
                    </button>
                    <button onclick="switchTab('advanced')" id="btn-advanced" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition font-bold text-sm">
                        <i data-lucide="award" class="w-5 h-5"></i> 高级画像
                    </button>
                    <button onclick="switchTab('skills')" id="btn-skills" class="tab-btn w-full flex items-center gap-3 px-4 py-3 rounded-2xl transition font-bold text-sm">
                        <i data-lucide="zap" class="w-5 h-5"></i> 卷的项目
                    </button>
                </nav>
                <div class="mt-8 pt-4 border-t border-gray-50 px-4">
                    <a href="{{ url_for('main.index') }}" class="flex items-center gap-2 text-xs text-gray-400 hover:text-indigo-600 transition">
                        <i data-lucide="arrow-left" class="w-3 h-3"></i> 返回看板
                    </a>
                </div>
            </div>
        </aside>

        <!-- 右侧内容区 -->
        <main class="flex-1">
            <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
                <!-- 头部预览 -->
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-8 text-white">
                    <div class="flex items-center gap-6">
                        <div class="h-20 w-20 bg-white/20 backdrop-blur-md rounded-3xl flex items-center justify-center text-3xl font-black">
                            {{ student.name[0] }}
                        </div>
                        <div>
                            <h1 class="text-3xl font-black">{{ student.name }}</h1>
                            <p class="opacity-80 text-sm font-mono mt-1">ID: {{ student.student_id }} · {{ student.class_name or '自由卷王' }}</p>
                        </div>
                    </div>
                </div>

                <!-- 板块容器 -->
                <div class="p-8">

                    <!-- 板块 1: 基本信息 -->
                    <div id="tab-basic" class="tab-content hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <h3 class="text-xl font-bold mb-6">基本档案</h3>
                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="action" value="update_basic">
                            <input type="hidden" name="active_tab" value="basic">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">姓名</label>
                                    <input type="text" name="name" value="{{ student.name }}" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">班级</label>
                                    <input type="text" name="class_name" value="{{ student.class_name or '' }}" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 transition">
                                </div>
                            </div>
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-2xl hover:shadow-lg hover:shadow-indigo-200 transition">保存基本修改</button>
                        </form>
                    </div>

                    <!-- 板块 2: 高级画像 -->
                    <div id="tab-advanced" class="tab-content hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <h3 class="text-xl font-bold mb-6">灵魂画像</h3>
                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="action" value="update_advanced">
                            <input type="hidden" name="active_tab" value="advanced">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">专属头衔</label>
                                <input type="text" name="title" value="{{ student.title or '' }}" placeholder="例如：深夜代码收割机" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-purple-500 transition">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-2">内卷金句 / 评价</label>
                                <textarea name="praice_sentence" rows="4" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-purple-500 transition">{{ student.praice_sentence or '' }}</textarea>
                            </div>
                            <button type="submit" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-2xl hover:shadow-lg hover:shadow-purple-200 transition">同步高级档案</button>
                        </form>
                    </div>

                    <!-- 板块 3: 卷的项目 -->
                    <div id="tab-skills" class="tab-content hidden animate-in fade-in slide-in-from-bottom-2 duration-300">
                        <h3 class="text-xl font-bold mb-6">内卷技能树</h3>

                        <!-- 已有技能展示 -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                            {% for sk in student.skills %}
                            <div class="flex items-center justify-between p-4 bg-indigo-50/50 border border-indigo-100 rounded-2xl group">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-indigo-100 text-indigo-600 rounded-xl">
                                        <i data-lucide="zap" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-800">{{ sk.power_info.power_name }}</div>
                                        <div class="text-[10px] text-indigo-400 font-black">强度 LV.{{ sk.level }}</div>
                                    </div>
                                </div>
                                <a href="{{ url_for('main.delete_skill', s_id=student.student_id, p_id=sk.power_id) }}" class="p-2 text-gray-300 hover:text-red-500 transition">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>

                        <hr class="border-gray-50 my-8">

                        <form method="POST" class="space-y-6">
                            <input type="hidden" name="action" value="add_skill">
                            <input type="hidden" name="active_tab" value="skills">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">库中技能</label>
                                    <select name="power_id" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 transition">
                                        <option value="">-- 自定义输入 --</option>
                                        {% for p in all_powers %}
                                        <option value="{{ p.power_id }}">{{ p.power_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">手动输入新项</label>
                                    <input type="text" name="custom_power_name" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 transition">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-2">强度 (0-100)</label>
                                    <input type="number" name="level" value="60" class="w-full px-4 py-3 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-orange-500 transition">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-gray-900 text-white font-bold py-4 rounded-2xl hover:bg-black transition flex items-center justify-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> 录入卷的项目
                            </button>
                        </form>
                    </div>

                </div>
            </div>
        </main>
    </div>
</div>

<script>
    function switchTab(tabId) {
        // 1. 隐藏所有内容板块
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.add('hidden');
        });

        // 2. 移除所有按钮的激活样式
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-100');
            btn.classList.add('text-gray-500', 'hover:bg-gray-50');
        });

        // 3. 显示当前选中的板块
        document.getElementById('tab-' + tabId).classList.remove('hidden');

        // 4. 设置当前按钮激活样式
        const activeBtn = document.getElementById('btn-' + tabId);
        activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-100');
        activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-50');

        // 5. 更新 URL hash (方便刷新后停留在当前页)
        window.location.hash = tabId;
    }

    // 初始化：检查 URL 中是否有指定的 tab
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const tabFromUrl = urlParams.get('tab');
        const tabFromHash = window.location.hash.replace('#', '');

        const defaultTab = tabFromUrl || tabFromHash || 'basic';
        switchTab(defaultTab);

        if (window.lucide) {
            window.lucide.createIcons();
        }
    });
</script>
{% endblock %}